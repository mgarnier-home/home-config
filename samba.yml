version: "3.8"

x-placement_apollon: &placement_apollon
  placement:
    constraints:
      - node.hostname == Apollon

x-placement_athena: &placement_athena
  placement:
    constraints:
      - node.hostname == Athena

x-placement_hermes: &placement_hermes
  placement:
    constraints:
      - node.hostname == Hermes

x-samba: &samba
  image: dperson/samba
  environment:
    - USERID=1000
    - GROUPID=1000
  ports:
    - target: 137
      published: 137
      mode: host
      protocol: udp
    - target: 138
      published: 138
      mode: host
      protocol: udp
    - target: 139
      published: 139
      mode: host
      protocol: tcp
    - target: 445
      published: 445
      mode: host
      protocol: tcp
  command: '-W -s "Share;/share;yes;no;no" -u "${SMB_USER};${SMB_PWD}"'

services:
  apollon_samba:
    <<: *samba
    volumes:
      - /home/mgarnier:/share:z
    deploy:
      <<: *placement_apollon

  athena_samba:
    <<: *samba
    volumes:
      - /home/mgarnier:/share/home
      - /hdd-1:/share/hdd-1
      - /hdd-2:/share/hdd-2
      - /hdd-3:/share/hdd-3
      - /ssd-1:/share/ssd-1
      - /big-hdd:/share/big-hdd
    deploy:
      <<: *placement_athena

  hermes_samba:
    <<: *samba
    volumes:
      - /home/mgarnier:/share
    deploy:
      <<: *placement_hermes
# x-o: &o
#   o: "rw,username=${SMB_USER},password=${SMB_PWD},iocharset=utf8,uid=1000,sec=ntlmv2,file_mode=0777,dir_mode=0777"

# volumes:
#   apollon_share:
#     driver: local
#     driver_opts:
#       type: cifs
#       device: //${APOLLON_IP}/share
#       <<: *o
#   athena_share:
#     driver: local
#     driver_opts:
#       type: cifs
#       device: //${ATHENA_IP}/share
#       <<: *o
#   hermes_share:
#     driver: local
#     driver_opts:
#       type: cifs
#       device: //${HERMES_IP}/share
#       <<: *o
