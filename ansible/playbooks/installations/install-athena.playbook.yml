- name: Fresh install of athena
  hosts: athena
  gather_facts: false
  pre_tasks:
    - name: Load installation variables
      ansible.builtin.include_vars:
        file: ../../variables/install.yml
      delegate_to: localhost
      run_once: true
  tasks:
    - name: Add contrib and non-free repositories for nvidia drivers
      become: true
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://deb.debian.org/debian/ bookworm main contrib non-free non-free-firmware"
        state: present
        insertafter: EOF

    - name: Setup NVIDIA container toolkit repositories # noqa: ansible-lint command-instead-of-module risky-shell-pipe
      ansible.builtin.shell:
        cmd: |
          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
          && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
          sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      become: true

    - name: Update packages
      become: true
      ansible.builtin.apt:
        update_cache: true

    - name: Mount disks
      become: true
      block:
        - name: Mount SSD1
          ansible.posix.mount:
            path: /ssd-1
            src: UUID=5cb14697-0fa5-4d9d-83cf-b3ee330952f7
            fstype: ext4
            opts: defaults
            state: present
        - name: Mount HDD1
          ansible.posix.mount:
            path: /hdd-1
            src: UUID=d1050c72-a2cb-472e-a1c1-52e4ad602afd
            fstype: ext4
            opts: defaults
            state: present
        - name: Mount HDD2
          ansible.posix.mount:
            path: /hdd-2
            src: UUID=036b53a5-1f19-498e-bbf9-0fa1548811b9
            fstype: ext4
            opts: defaults
            state: present
        - name: Mount HDD3
          ansible.posix.mount:
            path: /hdd-3
            src: UUID=c7836928-0c11-4728-88da-9f04429ed815
            fstype: ext4
            opts: defaults
            state: present
        - name: Mount Big HDD
          ansible.posix.mount:
            path: /big-hdd
            src: UUID=99afa81c-db4e-46aa-961e-1c78f5f81e59
            fstype: ext4
            opts: defaults
            state: present

    - name: Install docker
      ansible.builtin.include_tasks: tasks/install-docker.yml

    - name: Install tailscale
      ansible.builtin.include_tasks: tasks/install-tailscale.yml

    - name: Install nvidia
      block:
        - name: Install nvidia-drivers
          become: true
          ansible.builtin.apt:
            pkg:
              - nvidia-driver
              - firmware-misc-nonfree
            state: present
            update_cache: true
          notify: Reboot host

        - name: Install NVIDIA container toolkit
          become: true
          ansible.builtin.apt:
            pkg:
              - nvidia-container-toolkit
            state: present
            update_cache: true

        - name: Configure docker
          become: true
          ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
          changed_when: true
          notify: Restart docker

  handlers:
    - name: Reboot host
      become: true
      ansible.builtin.reboot:
        reboot_timeout: 300
        msg: "Rebooting the system to apply changes"

    - name: Restart docker
      become: true
      ansible.builtin.systemd:
        name: docker
        state: restarted
        enabled: true
